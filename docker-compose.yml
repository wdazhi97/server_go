version: '3.8'

services:
  # MongoDB 数据库
  mongodb:
    image: mongo:latest
    container_name: snake_game_mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    restart: unless-stopped

  # API网关服务
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
      - lobby-service
      - matching-service
      - room-service
      - leaderboard-service
      - game-service
      - friends-service
    command: ["./bin/gateway_server"]
    restart: unless-stopped

  # 大厅服务（用户注册登录）
  lobby-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lobby-service
    expose:
      - "50051"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/lobby_server"]
    restart: unless-stopped

  # 匹配服务
  matching-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: matching-service
    expose:
      - "50052"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/matching_server"]
    restart: unless-stopped

  # 房间服务
  room-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: room-service
    expose:
      - "50053"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/room_server"]
    restart: unless-stopped

  # 排行榜服务
  leaderboard-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: leaderboard-service
    expose:
      - "50054"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/leaderboard_server"]
    restart: unless-stopped

  # 游戏服务
  game-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: game-service
    expose:
      - "50055"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/game_server"]
    restart: unless-stopped

  # 好友服务
  friends-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: friends-service
    expose:
      - "50056"
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017
    depends_on:
      - mongodb
    command: ["./bin/friends_server"]
    restart: unless-stopped

volumes:
  mongodb_data: